<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/admin-layout :: head}">
    <link href="/static/css/searchable-dropdown.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Navigation -->
        <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

        <!-- Content -->
        <div class="container-fluid py-4">
            <!-- Flash Messages -->
            <div th:replace="~{fragments/admin-layout :: messages}"></div>

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary">
                        <i class="fas fa-user-plus me-2"></i>
                        <span th:text="${account.id != null ? 'Chỉnh Sửa Tài Khoản' : 'Thêm Tài Khoản Mới'}">Thêm Tài Khoản Mới</span>
                    </h2>
                    <p class="text-muted mb-0">Nhập thông tin chi tiết của tài khoản</p>
                </div>
                <a th:href="@{/admin/account}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Quay Lại
                </a>
            </div>

            <!-- Form -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="fas fa-user-edit me-2"></i>Thông Tin Tài Khoản
                            </h5>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/admin/account/save}" th:object="${account}" method="post">
                                <input type="hidden" th:field="*{id}" />

                                <!-- Basic Information -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="username" class="form-label">
                                            Tên Đăng Nhập <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="username" th:field="*{username}" 
                                               required placeholder="Nhập tên đăng nhập" 
                                               th:readonly="${account.id != null}">
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Tên đăng nhập không thể thay đổi sau khi tạo
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">
                                            Email <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="email" th:field="*{email}" 
                                               required placeholder="example@email.com">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="fullName" class="form-label">
                                        Họ và Tên <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="fullName" th:field="*{fullName}" 
                                           required placeholder="Nhập họ và tên đầy đủ">
                                </div>

                                <!-- Liên Kết Nhân Sự/Chấp Sự -->
                                <hr class="my-4" />
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-user-friends me-2"></i>Liên Kết Hồ Sơ
                                </h6>
                                
                                <div class="mb-3">
                                    <label class="form-label">Liên kết với hồ sơ (tùy chọn)</label>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="profileType" id="profileNhanSu" value="nhansu">
                                                <label class="form-check-label" for="profileNhanSu">
                                                    <i class="fas fa-user text-primary me-1"></i>Nhân Sự
                                                </label>
                                            </div>
                                            <div id="nhanSuDropdown" class="mt-2" style="display: none;"></div>
                                            <input type="hidden" id="nhanSu" th:field="*{nhanSu.id}">
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="profileType" id="profileChapSu" value="chapsu">
                                                <label class="form-check-label" for="profileChapSu">
                                                    <i class="fas fa-user-tie text-success me-1"></i>Chấp Sự
                                                </label>
                                            </div>
                                            <div id="chapSuDropdown" class="mt-2" style="display: none;"></div>
                                            <input type="hidden" id="chapSu" th:field="*{chapSu.id}">
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Chọn một trong hai loại để liên kết với tài khoản này
                                    </div>
                                </div>

                                <!-- Password Section - Only for new accounts -->
                                <div th:if="${account.id == null}">
                                    <hr class="my-4" />
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-key me-2"></i>Thông Tin Bảo Mật
                                    </h6>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Mật khẩu tự động:</strong> Hệ thống sẽ tự động tạo mật khẩu ngẫu nhiên cho tài khoản mới. 
                                        Mật khẩu sẽ được hiển thị sau khi tạo thành công.
                                    </div>
                                </div>

                                <!-- Update Info - Only for existing accounts -->
                                <div th:if="${account.id != null}">
                                    <hr class="my-4" />
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-edit me-2"></i>Cập Nhật Thông Tin
                                    </h6>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Lưu ý:</strong> Chỉ có thể cập nhật thông tin cơ bản. 
                                        Để thay đổi mật khẩu, vui lòng sử dụng chức năng "Reset Mật Khẩu" trong danh sách tài khoản.
                                    </div>
                                </div>

                                <!-- Role and Status -->
                                <hr class="my-4" />
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-shield-alt me-2"></i>Quyền và Trạng Thái
                                </h6>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="role" class="form-label">
                                            Quyền Hạn <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="role" th:field="*{role}" required>
                                            <option th:each="role : ${T(com.branch.demo.domain.Account.Role).values()}" 
                                                    th:value="${role}" th:text="${role.displayName}">
                                            </option>
                                        </select>
                                        <div class="form-text">
                                            <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                                            Chỉ Admin mới có quyền truy cập hệ thống quản lý
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="status" class="form-label">
                                            Trạng Thái <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="status" th:field="*{status}" required>
                                            <option th:each="status : ${T(com.branch.demo.domain.Account.AccountStatus).values()}" 
                                                    th:value="${status}" th:text="${status.displayName}">
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Submit Buttons -->
                                <hr class="my-4" />
                                <div class="d-flex justify-content-end gap-2">
                                    <a th:href="@{/admin/account}" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>Hủy
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>
                                        <span th:text="${account.id != null ? 'Cập Nhật' : 'Tạo Tài Khoản'}">Tạo Tài Khoản</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Hướng Dẫn
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6 class="text-primary">Quyền Hạn:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <span class="badge bg-danger me-2">ADMIN</span>
                                    Toàn quyền quản lý hệ thống
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-info me-2">MODERATOR</span>
                                    Quyền điều hành nội dung
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-secondary me-2">USER</span>
                                    Quyền người dùng cơ bản
                                </li>
                            </ul>

                            <hr>

                            <h6 class="text-primary">Trạng Thái:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <span class="badge bg-success me-2">ACTIVE</span>
                                    Tài khoản hoạt động bình thường
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-warning me-2">INACTIVE</span>
                                    Tài khoản tạm khóa
                                </li>
                                <li class="mb-2">
                                    <span class="badge bg-danger me-2">LOCKED</span>
                                    Tài khoản bị khóa
                                </li>
                            </ul>

                            <hr>

                            <hr>

                            <h6 class="text-primary">Liên Kết Hồ Sơ:</h6>
                            <p class="small text-muted mb-2">
                                Bạn có thể liên kết tài khoản này với một nhân sự hoặc chấp sự trong hệ thống. 
                                Khi liên kết, thông tin cá nhân sẽ được hiển thị từ hồ sơ tương ứng.
                            </p>
                            <ul class="list-unstyled small">
                                <li class="mb-1">
                                    <i class="fas fa-user text-primary me-2"></i>
                                    <strong>Nhân Sự:</strong> Liên kết với hồ sơ nhân sự
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-user-tie text-success me-2"></i>
                                    <strong>Chấp Sự:</strong> Liên kết với hồ sơ chấp sự
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-info text-info me-2"></i>
                                    Chỉ có thể chọn một trong hai loại
                                </li>
                                <li class="mb-1">
                                    <i class="fas fa-info text-info me-2"></i>
                                    Có thể để trống nếu chưa có hồ sơ tương ứng
                                </li>
                            </ul>

                            <hr>

                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Lưu ý:</strong> Chỉ tài khoản có quyền ADMIN mới có thể truy cập vào hệ thống quản lý.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div th:replace="~{fragments/admin-layout :: scripts}"></div>
    <script src="/static/js/searchable-dropdown.js"></script>

    <script th:inline="javascript">
        // Global variables
        let allNhanSu = [];
        let allChapSu = [];
        let nhanSuDropdown;
        let chapSuDropdown;
        
        // Account data from Thymeleaf
        const currentAccount = {
            id: /*[[${account.id}]]*/ null,
            nhanSuId: /*[[${account.nhanSu?.id}]]*/ null,
            chapSuId: /*[[${account.chapSu?.id}]]*/ null
        };
        
        const isEditMode = currentAccount.id !== null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            initializeProfileRadios();
            // Initialize existing data after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeExistingData();
            }, 200);
        });
        
        // Load all data from APIs
        async function loadAllData() {
            try {
                let nhanSuUrl, chapSuUrl;
                
                if (isEditMode) {
                    // EDIT mode: Load all active + current account's person
                    nhanSuUrl = `/admin/api/nhan-su-for-account-edit?accountId=${currentAccount.id}`;
                    chapSuUrl = `/admin/api/chap-su-for-account-edit?accountId=${currentAccount.id}`;
                } else {
                    // CREATE mode: Only load those without account
                    nhanSuUrl = '/admin/api/nhan-su-without-account';
                    chapSuUrl = '/admin/api/chap-su-without-account';
                }
                
                const [nhanSuResponse, chapSuResponse] = await Promise.all([
                    fetch(nhanSuUrl),
                    fetch(chapSuUrl)
                ]);
                
                if (nhanSuResponse.ok && chapSuResponse.ok) {
                    allNhanSu = await nhanSuResponse.json();
                    allChapSu = await chapSuResponse.json();
                    
                    console.log(`Loaded nhân sự (${isEditMode ? 'edit' : 'create'} mode):`, allNhanSu.length);
                    console.log(`Loaded chấp sự (${isEditMode ? 'edit' : 'create'} mode):`, allChapSu.length);
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Initialize profile type radio buttons
        function initializeProfileRadios() {
            const profileNhanSuRadio = document.getElementById('profileNhanSu');
            const profileChapSuRadio = document.getElementById('profileChapSu');
            
            profileNhanSuRadio.addEventListener('change', function() {
                if (this.checked) {
                    showProfileDropdown('nhansu');
                    hideProfileDropdown('chapsu');
                    // Clear ChapSu selection
                    document.getElementById('chapSu').value = '';
                }
            });
            
            profileChapSuRadio.addEventListener('change', function() {
                if (this.checked) {
                    showProfileDropdown('chapsu');
                    hideProfileDropdown('nhansu');
                    // Clear NhanSu selection
                    document.getElementById('nhanSu').value = '';
                }
            });
        }
        
        // Show profile dropdown
        function showProfileDropdown(type) {
            const dropdownContainer = document.getElementById(`${type === 'nhansu' ? 'nhanSu' : 'chapSu'}Dropdown`);
            dropdownContainer.style.display = 'block';
            
            if (type === 'nhansu') {
                createNhanSuDropdown();
            } else {
                createChapSuDropdown();
            }
        }
        
        // Hide profile dropdown
        function hideProfileDropdown(type) {
            const dropdownContainer = document.getElementById(`${type === 'nhansu' ? 'nhanSu' : 'chapSu'}Dropdown`);
            dropdownContainer.style.display = 'none';
            dropdownContainer.innerHTML = '';
        }
        
        // Create Nhân Sự dropdown
        function createNhanSuDropdown() {
            const container = document.getElementById('nhanSuDropdown');
            const currentValue = document.getElementById('nhanSu').value;
            
            if (container) {
                if (!allNhanSu || allNhanSu.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Tất cả nhân sự đã có tài khoản</div>';
                    return;
                }
                nhanSuDropdown = new SearchableDropdown(container, {
                    data: allNhanSu,
                    placeholder: 'Tìm kiếm nhân sự...',
                    displayField: 'hoTen',
                    valueField: 'id',
                    searchFields: ['hoTen', 'email', 'dienThoai'],
                    allowClear: true,
                    clearText: 'Không chọn nhân sự',
                    formatDisplayHTML: function(item) {
                        let html = '<div class="d-flex flex-column">';
                        html += '<div class="fw-medium">' + item.hoTen + '</div>';
                        if (item.chucVu) {
                            html += '<small class="text-muted">' + item.chucVu + '</small>';
                        }
                        html += '</div>';
                        return html;
                    },
                    onSelect: function(item) {
                        document.getElementById('nhanSu').value = item.id;
                    },
                    onClear: function() {
                        document.getElementById('nhanSu').value = '';
                    }
                });
                
                // Set selected value after creating dropdown
                if (currentValue && currentValue.trim() !== '') {
                    setTimeout(() => {
                        nhanSuDropdown.setValue(currentValue);
                    }, 100);
                }
            }
        }
        
        // Create Chấp Sự dropdown
        function createChapSuDropdown() {
            const container = document.getElementById('chapSuDropdown');
            const currentValue = document.getElementById('chapSu').value;
            
            if (container) {
                if (!allChapSu || allChapSu.length === 0) {
                    container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Tất cả chấp sự đã có tài khoản</div>';
                    return;
                }
                chapSuDropdown = new SearchableDropdown(container, {
                    data: allChapSu,
                    placeholder: 'Tìm kiếm chấp sự...',
                    displayField: 'hoTen',
                    valueField: 'id',
                    searchFields: ['hoTen', 'email', 'dienThoai'],
                    allowClear: true,
                    clearText: 'Không chọn chấp sự',
                    formatDisplayHTML: function(item) {
                        let html = '<div class="d-flex flex-column">';
                        html += '<div class="fw-medium">' + item.hoTen + '</div>';
                        if (item.chucVu) {
                            html += '<small class="text-muted">' + item.chucVu + '</small>';
                        }
                        html += '</div>';
                        return html;
                    },
                    onSelect: function(item) {
                        document.getElementById('chapSu').value = item.id;
                    },
                    onClear: function() {
                        document.getElementById('chapSu').value = '';
                    }
                });
                
                // Set selected value after creating dropdown
                if (currentValue && currentValue.trim() !== '') {
                    setTimeout(() => {
                        chapSuDropdown.setValue(currentValue);
                    }, 100);
                }
            }
        }
        
        // Initialize existing data (for edit mode)
        function initializeExistingData() {
            const nhanSuId = document.getElementById('nhanSu').value;
            const chapSuId = document.getElementById('chapSu').value;
            
            if (nhanSuId && nhanSuId.trim() !== '') {
                document.getElementById('profileNhanSu').checked = true;
                showProfileDropdown('nhansu');
            } else if (chapSuId && chapSuId.trim() !== '') {
                document.getElementById('profileChapSu').checked = true;
                showProfileDropdown('chapsu');
            }
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = document.getElementById(fieldId + 'ToggleIcon');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password confirmation validation - Only for new accounts
        const confirmPasswordField = document.getElementById('confirmPassword');
        const passwordField = document.getElementById('password');
        
        if (confirmPasswordField && passwordField) {
            confirmPasswordField.addEventListener('input', function() {
                const password = passwordField.value;
                const confirmPassword = this.value;
                const message = document.getElementById('passwordMatchMessage');
                const submitBtn = document.getElementById('submitBtn');

                if (confirmPassword && password !== confirmPassword) {
                    message.innerHTML = '<i class="fas fa-times text-danger me-1"></i>Mật khẩu không khớp';
                    message.className = 'form-text text-danger';
                    submitBtn.disabled = true;
                } else {
                    message.innerHTML = confirmPassword ? '<i class="fas fa-check text-success me-1"></i>Mật khẩu khớp' : '';
                    message.className = 'form-text text-success';
                    submitBtn.disabled = false;
                }
            });

            // Password strength indicator
            passwordField.addEventListener('input', function() {
                const password = this.value;
                const confirmField = document.getElementById('confirmPassword');
                
                // Reset confirm password when main password changes
                if (confirmField && confirmField.value) {
                    confirmField.dispatchEvent(new Event('input'));
                }
            });
        }
    </script>
</body>
</html>