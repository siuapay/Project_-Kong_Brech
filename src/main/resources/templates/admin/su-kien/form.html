<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/admin-layout :: head}">
    <link href="/static/css/searchable-dropdown.css" rel="stylesheet" />
  </head>

  <body class="modern-admin-page">
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

      <!-- Content -->
      <div class="container-fluid py-4">
        <!-- Flash Messages -->
        <div th:replace="~{fragments/admin-layout :: messages}"></div>

        <!-- Modern Page Header -->
        <div class="modern-page-header">
          <div class="header-content">
            <div class="header-info">
              <div class="header-icon">
                <i class="fas fa-calendar-plus"></i>
              </div>
              <div class="header-text">
                <h1
                  class="header-title"
                  th:text="${suKien.id != null ? 'Chỉnh Sửa Sự Kiện' : 'Thêm Sự Kiện Mới'}"
                >
                  Thêm Sự Kiện Mới
                </h1>
                <p class="header-subtitle">
                  Nhập thông tin chi tiết của sự kiện để quản lý hiệu quả
                </p>
              </div>
            </div>
            <div class="header-actions">
              <a
                th:href="@{/admin/su-kien}"
                class="btn-modern btn-modern-outline"
              >
                <i class="fas fa-arrow-left me-2"></i>Quay Lại
              </a>
            </div>
          </div>
        </div>

        <!-- Modern Form -->
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="modern-card">
              <div class="card-header">
                <div class="header-left">
                  <div class="card-icon">
                    <i class="fas fa-calendar-edit"></i>
                  </div>
                  <div class="card-title">
                    <h5>Thông Tin Sự Kiện</h5>
                    <p>Điền đầy đủ thông tin để tạo sự kiện</p>
                  </div>
                </div>
              </div>
              <div class="card-content">
                <form
                  th:action="@{/admin/su-kien/save}"
                  th:object="${suKien}"
                  method="post"
                  enctype="multipart/form-data"
                  class="needs-validation"
                  novalidate
                >
                  <input type="hidden" th:field="*{id}" />
                  <input type="hidden" th:field="*{createdAt}" />
                  <input type="hidden" th:field="*{hinhAnhUrl}" />

                  <!-- Modern Image Upload Section with Drag & Drop -->
                  <div class="image-upload-section" id="imageDropZone">
                    <div class="section-header">
                      <div class="section-icon">
                        <i class="fas fa-image"></i>
                      </div>
                      <div class="section-title">
                        <h4>Hình Ảnh Sự Kiện</h4>
                        <p>Kéo thả ảnh vào đây hoặc click để chọn file</p>
                      </div>
                    </div>

                    <div class="image-upload-container">
                      <!-- Image Preview with Drop Zone -->
                      <div class="image-preview-wrapper" id="imagePreviewWrapper">
                        <div class="image-preview-box">
                          <img
                            id="imagePreview"
                            th:src="${suKien.hinhAnhUrl != null ? suKien.hinhAnhUrl : '/static/images/default-event.svg'}"
                            alt="Event Image Preview"
                          />
                          <div class="image-overlay">
                            <i class="fas fa-camera"></i>
                            <span class="overlay-text">Kéo thả ảnh</span>
                          </div>
                        </div>
                        <div class="drop-indicator">
                          <i class="fas fa-cloud-upload-alt"></i>
                          <span>Thả ảnh vào đây</span>
                        </div>
                      </div>

                      <!-- Upload Controls -->
                      <div class="image-upload-controls">
                        <div class="upload-input-wrapper">
                          <label for="imageFile" class="upload-btn">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            Chọn Hình Ảnh
                          </label>
                          <input
                            type="file"
                            class="d-none"
                            id="imageFile"
                            name="hinhAnhFile"
                            accept="image/jpeg,image/jpg,image/png,image/gif"
                            onchange="previewImage(this)"
                          />
                        </div>

                        <div class="upload-info">
                          <div class="info-item">
                            <i
                              class="fas fa-check-circle text-success me-2"
                            ></i>
                            <span>JPG, JPEG, PNG, GIF</span>
                          </div>
                          <div class="info-item">
                            <i class="fas fa-weight-hanging text-info me-2"></i>
                            <span>Tối đa 5MB</span>
                          </div>
                          <div class="info-item">
                            <i class="fas fa-hand-pointer text-primary me-2"></i>
                            <span>Hỗ trợ kéo thả</span>
                          </div>
                        </div>

                        <!-- Upload Status -->
                        <div id="uploadStatus" class="upload-status d-none">
                          <div class="status-message">
                            <i class="fas fa-check-circle me-2"></i>
                            Hình ảnh mới đã được chọn. Nhấn "Lưu" để cập nhật.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Form Divider -->
                  <div class="form-divider">
                    <div class="divider-line"></div>
                    <div class="divider-text">
                      <i class="fas fa-info-circle me-2"></i>Thông tin cơ bản
                    </div>
                    <div class="divider-line"></div>
                  </div>

                  <!-- Basic Information -->
                  <div class="form-section">
                    <div class="row g-4">
                      <div class="col-md-8">
                        <div class="modern-form-group">
                          <label for="tenSuKien" class="modern-form-label">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Tên Sự Kiện <span class="required-star">*</span>
                          </label>
                          <input
                            type="text"
                            class="modern-form-control"
                            id="tenSuKien"
                            th:field="*{tenSuKien}"
                            required
                            placeholder="Nhập tên sự kiện"
                          />
                          <div class="form-feedback">
                            Vui lòng nhập tên sự kiện.
                          </div>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="modern-form-group">
                          <label for="loaiSuKienId" class="modern-form-label">
                            <i class="fas fa-tag me-2"></i>
                            Loại Sự Kiện <span class="required-star">*</span>
                          </label>
                          <select
                            class="modern-form-select"
                            id="loaiSuKienId"
                            th:field="*{loaiSuKienId}"
                            required
                          >
                            <option value="">-- Chọn loại sự kiện --</option>
                            <option
                              th:each="loai : ${danhSachLoaiSuKien}"
                              th:value="${loai.id}"
                              th:text="${loai.tenLoai}"
                              th:selected="${suKien.loaiSuKienId != null and suKien.loaiSuKienId == loai.id}"
                            >
                            </option>
                          </select>
                          <div class="form-feedback">
                            Vui lòng chọn loại sự kiện.
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-md-6">
                        <div class="modern-form-group">
                          <label for="ngayDienRa" class="modern-form-label">
                            <i class="fas fa-calendar-check me-2"></i>
                            Ngày Diễn Ra <span class="required-star">*</span>
                          </label>
                          <input
                            type="datetime-local"
                            class="modern-form-control"
                            id="ngayDienRa"
                            th:field="*{ngayDienRa}"
                            required
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="modern-form-group">
                          <label for="trangThai" class="modern-form-label">
                            <i class="fas fa-info-circle me-2"></i>
                            Trạng Thái
                          </label>
                          <select
                            class="modern-form-select"
                            id="trangThai"
                            th:field="*{trangThai}"
                          >
                            <option
                              th:value="DANG_CHUAN_BI"
                              th:selected="*{trangThai?.name() == 'DANG_CHUAN_BI'}"
                            >
                              Đang chuẩn bị
                            </option>
                            <option
                              th:value="DANG_DIEN_RA"
                              th:selected="*{trangThai?.name() == 'DANG_DIEN_RA'}"
                            >
                              Đang diễn ra
                            </option>
                            <option
                              th:value="DA_KET_THUC"
                              th:selected="*{trangThai?.name() == 'DA_KET_THUC'}"
                            >
                              Đã kết thúc
                            </option>
                            <option
                              th:value="DA_HUY"
                              th:selected="*{trangThai?.name() == 'DA_HUY'}"
                            >
                              Đã hủy
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Location Information -->
                  <div class="form-divider">
                    <div class="divider-line"></div>
                    <div class="divider-text">
                      <i class="fas fa-map-marker-alt me-2"></i>Thông tin địa
                      điểm
                    </div>
                    <div class="divider-line"></div>
                  </div>

                  <div class="form-section">
                    <div class="row g-4">
                      <div class="col-12">
                        <div class="modern-form-group">
                          <label for="diaDiem" class="modern-form-label">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Địa Điểm
                          </label>
                          <input
                            type="text"
                            class="modern-form-control"
                            id="diaDiem"
                            th:field="*{diaDiem}"
                            placeholder="Nhập địa điểm tổ chức sự kiện"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-12">
                        <div class="modern-form-group">
                          <label for="moTa" class="modern-form-label">
                            <i class="fas fa-align-left me-2"></i>
                            Mô Tả Sự Kiện
                          </label>
                          <textarea
                            class="modern-form-textarea"
                            id="moTa"
                            rows="4"
                            th:field="*{moTa}"
                            placeholder="Mô tả chi tiết về sự kiện..."
                          ></textarea>
                          <div class="form-hint">Tối đa 1000 ký tự</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Additional Information -->
                  <div class="form-divider">
                    <div class="divider-line"></div>
                    <div class="divider-text">
                      <i class="fas fa-info-circle me-2"></i>Thông tin bổ sung
                    </div>
                    <div class="divider-line"></div>
                  </div>

                  <div class="form-section">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <div class="modern-form-group">
                          <label
                            for="soLuongThamGiaDuKien"
                            class="modern-form-label"
                          >
                            <i class="fas fa-users me-2"></i>
                            Số Lượng Tham Gia Dự Kiến
                          </label>
                          <input
                            type="number"
                            class="modern-form-control"
                            id="soLuongThamGiaDuKien"
                            th:field="*{soLuongThamGiaDuKien}"
                            min="0"
                            placeholder="Số người dự kiến tham gia"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="modern-form-group">
                          <label
                            for="soLuongThamGiaThucTe"
                            class="modern-form-label"
                          >
                            <i class="fas fa-users-check me-2"></i>
                            Số Lượng Tham Gia Thực Tế
                          </label>
                          <input
                            type="number"
                            class="modern-form-control"
                            id="soLuongThamGiaThucTe"
                            th:field="*{soLuongThamGiaThucTe}"
                            min="0"
                            placeholder="Số người thực tế tham gia"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="row g-4 mt-2">
                      <div class="col-12">
                        <div class="modern-form-group">
                          <label for="ghiChu" class="modern-form-label">
                            <i class="fas fa-sticky-note me-2"></i>
                            Ghi Chú
                          </label>
                          <textarea
                            class="modern-form-textarea"
                            id="ghiChu"
                            rows="3"
                            th:field="*{ghiChu}"
                            placeholder="Ghi chú thêm về sự kiện..."
                          ></textarea>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Modern Form Actions -->
                  <div class="form-actions">
                    <div class="actions-container">
                      <a th:href="@{/admin/su-kien}" class="btn-cancel">
                        <i class="fas fa-times me-2"></i>Hủy Bỏ
                      </a>
                      <button type="submit" class="btn-submit">
                        <i class="fas fa-save me-2"></i>
                        <span
                          th:text="${suKien.id != null ? 'Cập Nhật' : 'Lưu Sự Kiện'}"
                          >Lưu Sự Kiện</span
                        >
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Modern Sidebar Info -->
          <div class="col-lg-4">
            <!-- Guidelines Card -->
            <div class="modern-card">
              <div class="card-header">
                <div class="header-left">
                  <div class="card-icon">
                    <i class="fas fa-lightbulb"></i>
                  </div>
                  <div class="card-title">
                    <h5>Hướng Dẫn</h5>
                    <p>Thông tin cần thiết khi tạo sự kiện</p>
                  </div>
                </div>
              </div>
              <div class="card-content">
                <div class="guideline-section">
                  <h4>Thông tin bắt buộc</h4>
                  <div class="requirement-list">
                    <div class="requirement-item">
                      <i class="fas fa-check-circle"></i>
                      <span>Tên sự kiện</span>
                    </div>
                    <div class="requirement-item">
                      <i class="fas fa-check-circle"></i>
                      <span>Ngày diễn ra</span>
                    </div>
                  </div>
                </div>

                <div class="guideline-section">
                  <h4>Lưu ý quan trọng</h4>
                  <div class="note-list">
                    <div class="note-item">
                      <i class="fas fa-calendar-alt"></i>
                      <span>Ngày diễn ra phải trong tương lai</span>
                    </div>
                    <div class="note-item">
                      <i class="fas fa-image"></i>
                      <span>Hình ảnh tối đa 5MB</span>
                    </div>
                    <div class="note-item">
                      <i class="fas fa-map-marker-alt"></i>
                      <span>Địa điểm nên rõ ràng, cụ thể</span>
                    </div>
                    <div class="note-item">
                      <i class="fas fa-users"></i>
                      <span>Số lượng tham gia giúp chuẩn bị tốt hơn</span>
                    </div>
                  </div>
                </div>

                <div class="warning-box">
                  <div class="warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                  </div>
                  <div class="warning-content">
                    <strong>Chú ý:</strong> Thông tin sự kiện sẽ được hiển thị
                    công khai cho các thành viên.
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats Card (if editing) -->
            <div class="modern-card" th:if="${suKien.id != null}">
              <div class="card-header">
                <div class="header-left">
                  <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                  </div>
                  <div class="card-title">
                    <h5>Thông Tin Hệ Thống</h5>
                    <p>Chi tiết về bản ghi</p>
                  </div>
                </div>
              </div>
              <div class="card-content">
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-value" th:text="${suKien.id}">-</div>
                    <div class="stat-label">ID Sự Kiện</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">
                      <span
                        th:if="${suKien.createdAt}"
                        th:text="${#temporals.format(suKien.createdAt, 'dd/MM/yyyy')}"
                        >-</span
                      >
                      <span th:unless="${suKien.createdAt}">-</span>
                    </div>
                    <div class="stat-label">Ngày Tạo</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <div th:replace="~{fragments/admin-layout :: scripts}"></div>

    <script>
      // Form validation
      (function () {
        "use strict";
        window.addEventListener(
          "load",
          function () {
            var forms = document.getElementsByClassName("needs-validation");
            var validation = Array.prototype.filter.call(
              forms,
              function (form) {
                form.addEventListener(
                  "submit",
                  function (event) {
                    // Custom validation for loaiSuKien
                    const loaiSuKienInput =
                      document.getElementById("loaiSuKienId");
                    if (
                      !loaiSuKienInput.value ||
                      loaiSuKienInput.value.trim() === ""
                    ) {
                      event.preventDefault();
                      event.stopPropagation();

                      // Scroll to loaiSuKien field and highlight it
                      const loaiSuKienSelect =
                        document.getElementById("loaiSuKienId");
                      loaiSuKienSelect.scrollIntoView({
                        behavior: "smooth",
                        block: "center",
                      });

                      // Add error styling
                      loaiSuKienSelect.style.border = "2px solid #e53e3e";
                      loaiSuKienSelect.style.borderRadius = "8px";

                      // Remove error styling after 3 seconds
                      setTimeout(() => {
                        loaiSuKienSelect.style.border = "";
                        loaiSuKienSelect.style.borderRadius = "";
                      }, 3000);

                      return false;
                    }

                    if (form.checkValidity() === false) {
                      event.preventDefault();
                      event.stopPropagation();
                    }
                    form.classList.add("was-validated");
                  },
                  false
                );
              }
            );
          },
          false
        );
      })();

      // Loại sự kiện dropdown is now handled by Thymeleaf server-side rendering

      document.addEventListener("DOMContentLoaded", function () {
        // Convert select to searchable dropdown
        const selectElement = document.getElementById('loaiSuKienId');
        const options = Array.from(selectElement.options);
        let isValidSelection = false;
        
        // Create search input
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'modern-form-select';
        searchInput.placeholder = 'Tìm kiếm loại sự kiện...';
        searchInput.autocomplete = 'off';
        searchInput.required = true;
        
        // Create dropdown container
        const dropdownContainer = document.createElement('div');
        dropdownContainer.className = 'search-dropdown-container';
        dropdownContainer.style.position = 'relative';
        
        // Create options list
        const optionsList = document.createElement('div');
        optionsList.className = 'search-options-list';
        optionsList.style.cssText = `
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: white;
          border: 1px solid #ddd;
          border-top: none;
          max-height: 200px;
          overflow-y: auto;
          z-index: 1000;
          display: none;
        `;
        
        // Hide original select
        selectElement.style.display = 'none';
        
        // Insert new elements
        selectElement.parentNode.insertBefore(dropdownContainer, selectElement);
        dropdownContainer.appendChild(searchInput);
        dropdownContainer.appendChild(optionsList);
        
        // Populate options
        function populateOptions(filter = '') {
          optionsList.innerHTML = '';
          options.forEach(option => {
            if (option.value && option.text.toLowerCase().includes(filter.toLowerCase())) {
              const optionDiv = document.createElement('div');
              optionDiv.textContent = option.text;
              optionDiv.style.cssText = 'padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;';
              optionDiv.addEventListener('mouseenter', () => optionDiv.style.backgroundColor = '#f5f5f5');
              optionDiv.addEventListener('mouseleave', () => optionDiv.style.backgroundColor = 'white');
              optionDiv.addEventListener('click', () => {
                selectElement.value = option.value;
                searchInput.value = option.text;
                optionsList.style.display = 'none';
                isValidSelection = true;
                searchInput.style.borderColor = '#ddd';
                searchInput.setCustomValidity('');
              });
              optionsList.appendChild(optionDiv);
            }
          });
        }
        
        // Search functionality
        searchInput.addEventListener('input', function() {
          populateOptions(this.value);
          optionsList.style.display = 'block';
          
          // Reset validation when user types
          isValidSelection = false;
          selectElement.value = '';
          
          // Check if input matches any option exactly
          const exactMatch = options.find(opt => opt.text === this.value && opt.value);
          if (exactMatch) {
            isValidSelection = true;
            selectElement.value = exactMatch.value;
            this.style.borderColor = '#ddd';
            this.setCustomValidity('');
          } else {
            this.style.borderColor = '#dc3545';
            this.setCustomValidity('Vui lòng chọn từ danh sách có sẵn');
          }
        });
        
        searchInput.addEventListener('focus', function() {
          populateOptions(this.value);
          optionsList.style.display = 'block';
        });
        
        searchInput.addEventListener('blur', function() {
          setTimeout(() => {
            if (!isValidSelection && this.value.trim() !== '') {
              this.style.borderColor = '#dc3545';
              this.setCustomValidity('Vui lòng chọn từ danh sách có sẵn');
            } else if (this.value.trim() === '') {
              this.style.borderColor = '#dc3545';
              this.setCustomValidity('Vui lòng chọn loại sự kiện');
            }
          }, 200);
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!dropdownContainer.contains(e.target)) {
            optionsList.style.display = 'none';
          }
        });
        
        // Set initial value for edit mode
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (selectedOption && selectedOption.value) {
          searchInput.value = selectedOption.text;
          isValidSelection = true;
        }
        
        // Form validation before submit
        const form = selectElement.closest('form');
        if (form) {
          form.addEventListener('submit', function(e) {
            // Validate loại sự kiện
            if (!isValidSelection || !selectElement.value) {
              e.preventDefault();
              searchInput.style.borderColor = '#dc3545';
              searchInput.setCustomValidity('Vui lòng chọn loại sự kiện từ danh sách');
              searchInput.reportValidity();
              return false;
            }
            
            // Validate other required fields
            const tenSuKien = document.getElementById('tenSuKien');
            const ngayDienRa = document.getElementById('ngayDienRa');
            
            if (!tenSuKien.value.trim()) {
              tenSuKien.style.borderColor = '#dc3545';
              tenSuKien.setCustomValidity('Vui lòng nhập tên sự kiện');
              tenSuKien.reportValidity();
              e.preventDefault();
              return false;
            }
            
            if (!ngayDienRa.value) {
              ngayDienRa.style.borderColor = '#dc3545';
              ngayDienRa.setCustomValidity('Vui lòng chọn ngày diễn ra');
              ngayDienRa.reportValidity();
              e.preventDefault();
              return false;
            }
          });
        }
        
        // Add validation for other required fields
        const tenSuKien = document.getElementById('tenSuKien');
        const ngayDienRa = document.getElementById('ngayDienRa');
        
        if (tenSuKien) {
          tenSuKien.addEventListener('input', function() {
            if (this.value.trim()) {
              this.style.borderColor = '#ddd';
              this.setCustomValidity('');
            } else {
              this.style.borderColor = '#dc3545';
              this.setCustomValidity('Vui lòng nhập tên sự kiện');
            }
          });
        }
        
        if (ngayDienRa) {
          ngayDienRa.addEventListener('change', function() {
            if (this.value) {
              this.style.borderColor = '#ddd';
              this.setCustomValidity('');
            } else {
              this.style.borderColor = '#dc3545';
              this.setCustomValidity('Vui lòng chọn ngày diễn ra');
            }
          });
        }
      });

      // Removed loadAllLoaiSuKien function - using Thymeleaf server-side rendering

      // Image preview
      function previewImage(input) {
        const file = input.files[0];
        handleImageFile(file, input);
      }

      // Handle image file (for both file input and drag & drop)
      function handleImageFile(file, input) {
        const preview = document.getElementById('imagePreview');
        const status = document.getElementById('uploadStatus');
        const fileInput = document.getElementById('imageFile');

        if (file) {
          // Validate file size (5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
            if (input) input.value = '';
            return false;
          }

          // Validate file type
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
          if (!allowedTypes.includes(file.type)) {
            alert('Định dạng file không được hỗ trợ! Chỉ chấp nhận JPG, JPEG, PNG, GIF.');
            if (input) input.value = '';
            return false;
          }

          // Show preview
          const reader = new FileReader();
          reader.onload = function (e) {
            preview.src = e.target.result;
            status.classList.remove('d-none');
          };
          reader.readAsDataURL(file);

          // If file came from drag & drop, update the file input
          if (!input) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
          }

          return true;
        }
        return false;
      }

      // Drag & Drop functionality
      (function initDragDrop() {
        const preview = document.getElementById('imagePreview');
        const dropZone = document.getElementById('imageDropZone');
        const previewWrapper = document.getElementById('imagePreviewWrapper');
        
        if (!dropZone || !preview) return;

        // Store original image URL for reset
        preview.setAttribute('data-original', preview.src);

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        // Highlight drop zone when dragging over it
        ['dragenter', 'dragover'].forEach(eventName => {
          dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
          dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
          dropZone.classList.add('drag-over');
          previewWrapper.classList.add('drag-over');
        }

        function unhighlight(e) {
          dropZone.classList.remove('drag-over');
          previewWrapper.classList.remove('drag-over');
        }

        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            handleImageFile(files[0], null);
          }
        }
      })();

      // Date validation
      const dateInput = document.getElementById("ngayDienRa");
      const today = new Date();
      const todayString = today.toISOString().slice(0, 16);
      dateInput.setAttribute("min", todayString);

      dateInput.addEventListener("change", function (e) {
        const selectedDate = new Date(this.value);
        const currentDate = new Date();

        if (selectedDate < currentDate) {
          alert("Ngày diễn ra không thể trong quá khứ!");
          this.value = "";
        }
      });

      // Number validation
      const numberInput = document.getElementById("soLuongThamGiaDuKien");
      numberInput.addEventListener("input", function (e) {
        if (this.value < 0) {
          this.value = 0;
        }
      });
    </script>

    <!-- Modern Form Page Styles -->
    <style>
      /* Modern Admin Page Styles */
      .modern-admin-page {
        background: linear-gradient(
          135deg,
          #f5f7fa 0%,
          #c3cfe2 100%
        ) !important;
        min-height: 100vh;
      }

      /* Modern Page Header */
      .modern-page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-info {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .header-icon {
        width: 70px;
        height: 70px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
      }

      .header-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 0.5rem 0 0 0;
      }

      .header-actions {
        display: flex;
        gap: 1rem;
      }

      /* Modern Buttons */
      .btn-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
      }

      .btn-modern-outline {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      .btn-modern-outline:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        text-decoration: none;
      }

      /* Modern Cards */
      .modern-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .card-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
      }

      .card-title h5 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #2d3748;
      }

      .card-title p {
        margin: 0.25rem 0 0 0;
        font-size: 0.875rem;
        color: #718096;
      }

      .card-content {
        padding: 2rem;
      }

      /* Image Upload Section with Drag & Drop */
      .image-upload-section {
        background: #f8fafc;
        border: 2px dashed #e2e8f0;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        transition: all 0.3s ease;
      }

      .image-upload-section.drag-over {
        border-color: #667eea;
        background: linear-gradient(135deg, #e6f0ff 0%, #d4e4ff 100%);
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        transform: scale(1.01);
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .section-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
      }

      .section-title h4 {
        margin: 0;
        color: #2d3748;
        font-weight: 700;
      }

      .section-title p {
        margin: 0.25rem 0 0 0;
        color: #718096;
        font-size: 0.875rem;
      }

      .image-upload-container {
        display: flex;
        align-items: center;
        gap: 2rem;
        justify-content: center;
      }

      .image-preview-wrapper {
        position: relative;
        transition: all 0.3s ease;
      }

      .image-preview-wrapper.drag-over {
        transform: scale(1.05);
      }

      .image-preview-wrapper.drag-over .drop-indicator {
        opacity: 1;
        visibility: visible;
      }

      .image-preview-box {
        width: 150px;
        height: 150px;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 3px solid #e2e8f0;
      }

      .image-preview-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(102, 126, 234, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        gap: 0.5rem;
      }

      .image-overlay .overlay-text {
        font-size: 12px;
        font-weight: 500;
      }

      .image-preview-box:hover .image-overlay {
        opacity: 1;
      }

      .drop-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(102, 126, 234, 0.95);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 10;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      .drop-indicator i {
        font-size: 2rem;
      }

      .drop-indicator span {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
      }

      .image-upload-controls {
        text-align: left;
      }

      .upload-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      }

      .upload-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .info-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #718096;
      }

      .upload-status {
        background: #c6f6d5;
        border: 1px solid #9ae6b4;
        border-radius: 8px;
        padding: 0.75rem;
      }

      .status-message {
        color: #22543d;
        font-weight: 600;
        display: flex;
        align-items: center;
      }

      /* Form Sections */
      .form-divider {
        display: flex;
        align-items: center;
        margin: 2rem 0;
      }

      .divider-line {
        flex: 1;
        height: 1px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
      }

      .divider-text {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 25px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        font-size: 0.95rem;
        text-transform: none;
        letter-spacing: normal;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .divider-text:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .form-section {
        margin-bottom: 2rem;
      }

      /* Modern Form Controls */
      .modern-form-group {
        margin-bottom: 1.5rem;
      }

      .modern-form-label {
        display: flex;
        align-items: center;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
      }

      .required-star {
        color: #e53e3e;
        margin-left: 0.25rem;
      }

      .modern-form-control,
      .modern-form-select,
      .modern-form-textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      .modern-form-control:focus,
      .modern-form-select:focus,
      .modern-form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .modern-form-textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-feedback {
        color: #e53e3e;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
      }

      .form-hint {
        color: #718096;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }

      /* Form Actions */
      .form-actions {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #e2e8f0;
      }

      .actions-container {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

      .btn-cancel {
        padding: 0.875rem 2rem;
        background: #f7fafc;
        color: #4a5568;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
      }

      .btn-cancel:hover {
        background: #edf2f7;
        color: #2d3748;
        text-decoration: none;
      }

      .btn-submit {
        padding: 0.875rem 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
      }

      /* Sidebar Styles */
      .guideline-section {
        margin-bottom: 2rem;
      }

      .guideline-section h4 {
        color: #2d3748;
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }

      .requirement-list,
      .note-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .requirement-item,
      .note-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #4a5568;
        font-size: 0.875rem;
      }

      .requirement-item i {
        color: #38a169;
      }

      .note-item i {
        color: #667eea;
      }

      .warning-box {
        background: #fef5e7;
        border: 1px solid #f6e05e;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
      }

      .warning-icon {
        color: #d69e2e;
        font-size: 1.25rem;
      }

      .warning-content {
        color: #744210;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .stat-item {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 12px;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.75rem;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .header-actions {
          justify-content: center;
        }

        .image-upload-container {
          flex-direction: column;
          gap: 1rem;
        }

        .actions-container {
          flex-direction: column;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
      
      /* Validation Error Styles */
      .modern-form-select:invalid,
      .modern-form-input:invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
      }
      
      .search-dropdown-container input:invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
      }
      
      .form-feedback {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      
      /* Custom validation message */
      .validation-error {
        border-color: #dc3545 !important;
        background-color: #fff5f5 !important;
      }
    </style>
  </body>
</html>
