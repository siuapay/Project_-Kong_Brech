<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/admin-layout :: head}"></head>
  <body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

      <!-- Content -->
      <div class="container-fluid py-4">
        <!-- Flash Messages -->
        <div th:replace="~{fragments/admin-layout :: messages}"></div>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2 class="text-primary">
              <i class="fas fa-plus-circle me-2" th:if="${!isEdit}"></i>
              <i class="fas fa-edit me-2" th:if="${isEdit}"></i>
              <span
                th:text="${isEdit} ? 'Sửa Giao Dịch Tài Chính' : 'Thêm Giao Dịch Tài Chính'"
                >Thêm Giao Dịch</span
              >
            </h2>
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a th:href="@{/admin}">Dashboard</a>
                </li>
                <li class="breadcrumb-item">
                  <a th:href="@{/admin/tai-chinh/giao-dich}"
                    >Giao Dịch Tài Chính</a
                  >
                </li>
                <li
                  class="breadcrumb-item active"
                  th:text="${isEdit} ? 'Sửa' : 'Thêm'"
                >
                  Thêm
                </li>
              </ol>
            </nav>
          </div>
          <a
            th:href="@{/admin/tai-chinh/giao-dich}"
            class="btn btn-outline-secondary"
          >
            <i class="fas fa-arrow-left me-2"></i>Quay Lại
          </a>
        </div>

        <!-- Form -->
        <div class="row justify-content-center">
          <div class="col-lg-10">
            <div class="card shadow border-0">
              <div class="card-header bg-light">
                <h5 class="mb-0">
                  <i class="fas fa-info-circle me-2"></i>Thông Tin Giao Dịch
                </h5>
              </div>
              <div class="card-body">
                <form
                  th:action="@{/admin/tai-chinh/giao-dich/save}"
                  method="post"
                  th:object="${giaoDichDTO}"
                >
                  <input type="hidden" th:field="*{id}" />

                  <div class="row g-4">
                    <!-- Thời Gian và Loại -->
                    <div class="col-md-6">
                      <label for="thoiGian" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i>Thời Gian Giao
                        Dịch
                        <span class="text-danger">*</span>
                      </label>
                      <input
                        type="datetime-local"
                        class="form-control"
                        id="thoiGian"
                        th:field="*{thoiGian}"
                        th:classappend="${#fields.hasErrors('thoiGian')} ? 'is-invalid'"
                        required
                      />
                      <div
                        class="invalid-feedback"
                        th:if="${#fields.hasErrors('thoiGian')}"
                        th:errors="*{thoiGian}"
                      >
                        Lỗi thời gian
                      </div>
                    </div>

                    <div class="col-md-6">
                      <label for="loai" class="form-label">
                        <i class="fas fa-exchange-alt me-1"></i>Loại Giao Dịch
                        <span class="text-danger">*</span>
                      </label>
                      <select
                        class="form-select"
                        id="loai"
                        th:field="*{loai}"
                        th:classappend="${#fields.hasErrors('loai')} ? 'is-invalid'"
                        required
                        onchange="updateCategoryOptions()"
                      >
                        <option value="">Chọn loại giao dịch...</option>
                        <option
                          th:each="loaiValue : ${loaiGiaoDichValues}"
                          th:value="${loaiValue.name()}"
                          th:text="${loaiValue.displayName}"
                          th:selected="${giaoDichDTO.loai == loaiValue.name()}"
                        >
                          Loại
                        </option>
                      </select>
                      <div
                        class="invalid-feedback"
                        th:if="${#fields.hasErrors('loai')}"
                        th:errors="*{loai}"
                      >
                        Lỗi loại giao dịch
                      </div>
                    </div>

                    <!-- Số Tiền -->
                    <div class="col-md-6">
                      <label for="soTien" class="form-label">
                        <i class="fas fa-money-bill-wave me-1"></i>Số Tiền
                        <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        <input
                          type="number"
                          class="form-control"
                          id="soTien"
                          th:field="*{soTien}"
                          th:classappend="${#fields.hasErrors('soTien')} ? 'is-invalid'"
                          placeholder="Nhập số tiền..."
                          min="1"
                          step="1"
                          required
                        />
                        <span class="input-group-text">VNĐ</span>
                      </div>
                      <div
                        class="invalid-feedback"
                        th:if="${#fields.hasErrors('soTien')}"
                        th:errors="*{soTien}"
                      >
                        Lỗi số tiền
                      </div>
                      <div class="form-text">Số tiền phải lớn hơn 0</div>
                    </div>

                    <!-- Danh Mục -->
                    <div class="col-md-6">
                      <label for="danhMucId" class="form-label">
                        <i class="fas fa-folder me-1"></i>Danh Mục
                        <span class="text-danger">*</span>
                      </label>
                      <select
                        class="form-select"
                        id="danhMucId"
                        th:field="*{danhMucId}"
                        th:classappend="${#fields.hasErrors('danhMucId')} ? 'is-invalid'"
                        required
                      >
                        <option value="">Chọn danh mục...</option>
                        <option
                          th:each="dm : ${danhMucList}"
                          th:value="${dm.id}"
                          th:text="${dm.tenDanhMuc}"
                          th:data-loai="${dm.loai.name()}"
                          th:selected="${giaoDichDTO.danhMucId == dm.id}"
                        >
                          Danh mục
                        </option>
                      </select>
                      <div
                        class="invalid-feedback"
                        th:if="${#fields.hasErrors('danhMucId')}"
                        th:errors="*{danhMucId}"
                      >
                        Lỗi danh mục
                      </div>
                      <div class="form-text">
                        Danh mục phải phù hợp với loại giao dịch
                      </div>
                    </div>

                    <!-- Người Phụ Trách -->
                    <div class="col-md-6">
                      <label for="nguoiPhuTrachId" class="form-label">
                        <i class="fas fa-user me-1"></i>Người Phụ Trách
                      </label>
                      <select
                        class="form-select"
                        id="nguoiPhuTrachId"
                        th:field="*{nguoiPhuTrachId}"
                      >
                        <option value="">Chọn người phụ trách...</option>
                        <option
                          th:each="ns : ${nhanSuList}"
                          th:value="${ns.id}"
                          th:text="${ns.hoTen + ' (' + (ns.chucVu != null ? ns.chucVu.displayName : 'Chưa có chức vụ') + ')'}"
                          th:selected="${giaoDichDTO.nguoiPhuTrachId == ns.id}"
                        >
                          Người phụ trách
                        </option>
                      </select>
                    </div>

                    <!-- Nội Dung -->
                    <div class="col-12">
                      <label for="noiDung" class="form-label">
                        <i class="fas fa-align-left me-1"></i>Nội Dung Giao Dịch
                        <span class="text-danger">*</span>
                      </label>
                      <textarea
                        class="form-control"
                        id="noiDung"
                        rows="4"
                        th:field="*{noiDung}"
                        th:classappend="${#fields.hasErrors('noiDung')} ? 'is-invalid'"
                        placeholder="Nhập nội dung chi tiết về giao dịch..."
                        maxlength="1000"
                        required
                      ></textarea>
                      <div
                        class="invalid-feedback"
                        th:if="${#fields.hasErrors('noiDung')}"
                        th:errors="*{noiDung}"
                      >
                        Lỗi nội dung
                      </div>
                      <div class="form-text">Tối đa 1000 ký tự</div>
                    </div>
                  </div>

                  <!-- Preview Section -->
                  <div class="mt-4">
                    <h6 class="text-muted mb-3">
                      <i class="fas fa-eye me-1"></i>Xem Trước Giao Dịch
                    </h6>
                    <div class="card bg-light">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <div class="col-auto">
                            <div
                              class="avatar-lg rounded-circle d-flex align-items-center justify-content-center"
                              id="previewIcon"
                            >
                              <i
                                class="fas fa-exchange-alt fa-2x text-white"
                              ></i>
                            </div>
                          </div>
                          <div class="col">
                            <div
                              class="d-flex justify-content-between align-items-start"
                            >
                              <div>
                                <h5 class="mb-1" id="previewContent">
                                  Nội dung giao dịch sẽ hiển thị ở đây
                                </h5>
                                <div class="d-flex align-items-center gap-3">
                                  <span class="badge" id="previewTypeBadge"
                                    >Loại</span
                                  >
                                  <small class="text-muted" id="previewCategory"
                                    >Danh mục</small
                                  >
                                  <small class="text-muted" id="previewPerson"
                                    >Người phụ trách</small
                                  >
                                </div>
                                <small class="text-muted" id="previewTime"
                                  >Thời gian</small
                                >
                              </div>
                              <div class="text-end">
                                <h4 class="mb-0" id="previewAmount">0 VNĐ</h4>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex justify-content-between mt-4">
                    <a
                      th:href="@{/admin/tai-chinh/giao-dich}"
                      class="btn btn-outline-secondary"
                    >
                      <i class="fas fa-times me-1"></i>Hủy
                    </a>
                    <button type="submit" class="btn btn-primary">
                      <i class="fas fa-save me-1"></i>
                      <span th:text="${isEdit} ? 'Cập Nhật' : 'Lưu Giao Dịch'"
                        >Lưu</span
                      >
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <div th:replace="~{fragments/admin-layout :: scripts}"></div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const thoiGianInput = document.getElementById("thoiGian");
        const loaiSelect = document.getElementById("loai");
        const soTienInput = document.getElementById("soTien");
        const danhMucSelect = document.getElementById("danhMucId");
        const nguoiPhuTrachSelect = document.getElementById("nguoiPhuTrachId");
        const noiDungTextarea = document.getElementById("noiDung");

        const previewContent = document.getElementById("previewContent");
        const previewTypeBadge = document.getElementById("previewTypeBadge");
        const previewCategory = document.getElementById("previewCategory");
        const previewPerson = document.getElementById("previewPerson");
        const previewTime = document.getElementById("previewTime");
        const previewAmount = document.getElementById("previewAmount");
        const previewIcon = document.getElementById("previewIcon");

        function updatePreview() {
          const noiDung =
            noiDungTextarea.value || "Nội dung giao dịch sẽ hiển thị ở đây";
          const loai = loaiSelect.value;
          const soTien = soTienInput.value;
          const thoiGian = thoiGianInput.value;

          const selectedCategory =
            danhMucSelect.options[danhMucSelect.selectedIndex];
          const categoryName = selectedCategory.text || "Chưa chọn danh mục";

          const selectedPerson =
            nguoiPhuTrachSelect.options[nguoiPhuTrachSelect.selectedIndex];
          const personName = selectedPerson.text || "Chưa chọn người phụ trách";

          previewContent.textContent = noiDung;
          previewCategory.textContent = categoryName;
          previewPerson.textContent = personName;

          if (loai === "THU") {
            previewTypeBadge.textContent = "Thu";
            previewTypeBadge.className = "badge bg-success";
            previewIcon.className =
              "avatar-lg rounded-circle d-flex align-items-center justify-content-center bg-success";
            previewIcon.innerHTML =
              '<i class="fas fa-arrow-up fa-2x text-white"></i>';
            previewAmount.className = "mb-0 text-success";
          } else if (loai === "CHI") {
            previewTypeBadge.textContent = "Chi";
            previewTypeBadge.className = "badge bg-danger";
            previewIcon.className =
              "avatar-lg rounded-circle d-flex align-items-center justify-content-center bg-danger";
            previewIcon.innerHTML =
              '<i class="fas fa-arrow-down fa-2x text-white"></i>';
            previewAmount.className = "mb-0 text-danger";
          } else {
            previewTypeBadge.textContent = "Loại";
            previewTypeBadge.className = "badge bg-secondary";
            previewIcon.className =
              "avatar-lg rounded-circle d-flex align-items-center justify-content-center bg-secondary";
            previewIcon.innerHTML =
              '<i class="fas fa-exchange-alt fa-2x text-white"></i>';
            previewAmount.className = "mb-0";
          }

          if (soTien) {
            const formattedAmount = new Intl.NumberFormat("vi-VN").format(
              soTien
            );
            previewAmount.textContent = formattedAmount + " VNĐ";
          } else {
            previewAmount.textContent = "0 VNĐ";
          }

          if (thoiGian) {
            const date = new Date(thoiGian);
            previewTime.textContent = date.toLocaleString("vi-VN");
          } else {
            previewTime.textContent = "Chưa chọn thời gian";
          }
        }

        function updateCategoryOptions() {
          const selectedLoai = loaiSelect.value;
          const options = danhMucSelect.querySelectorAll("option[data-loai]");

          options.forEach((option) => {
            if (selectedLoai === "" || option.dataset.loai === selectedLoai) {
              option.style.display = "";
            } else {
              option.style.display = "none";
            }
          });

          // Reset selection if current selection is not compatible
          const currentSelection =
            danhMucSelect.options[danhMucSelect.selectedIndex];
          if (
            currentSelection &&
            currentSelection.dataset.loai &&
            selectedLoai !== "" &&
            currentSelection.dataset.loai !== selectedLoai
          ) {
            danhMucSelect.value = "";
          }

          updatePreview();
        }

        // Event listeners
        thoiGianInput.addEventListener("change", updatePreview);
        loaiSelect.addEventListener("change", updateCategoryOptions);
        soTienInput.addEventListener("input", updatePreview);
        danhMucSelect.addEventListener("change", updatePreview);
        nguoiPhuTrachSelect.addEventListener("change", updatePreview);
        noiDungTextarea.addEventListener("input", updatePreview);

        // Initial setup
        updateCategoryOptions();
        updatePreview();
      });

      // Global function for category update (called from HTML)
      function updateCategoryOptions() {
        const event = new Event("change");
        document.getElementById("loai").dispatchEvent(event);
      }
    </script>
  </body>
</html>
