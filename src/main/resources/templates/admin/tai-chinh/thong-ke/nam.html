<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/admin-layout :: head}"></head>
  <body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

      <!-- Content -->
      <div class="container-fluid py-4">
        <!-- Flash Messages -->
        <div th:replace="~{fragments/admin-layout :: messages}"></div>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="h3 mb-0" th:text="${pageTitle}">
              Thống Kê Tài Chính Năm
            </h1>
            <p class="text-muted">
              Chi tiết thu chi theo năm <span th:text="${nam}">2025</span>
            </p>
          </div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/admin}">Trang chủ</a>
              </li>
              <li class="breadcrumb-item">
                <a th:href="@{/admin/tai-chinh/thong-ke}">Thống kê</a>
              </li>
              <li class="breadcrumb-item active" th:text="'Năm ' + ${nam}">
                Năm 2025
              </li>
            </ol>
          </nav>
        </div>

        <!-- Year Selector -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calendar-alt me-2"></i>Chọn Năm
            </h5>
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-4">
                <select
                  class="form-select"
                  id="yearSelector"
                  onchange="changeYear()"
                >
                  <option
                    th:each="year : ${availableYears}"
                    th:value="${year}"
                    th:text="${year}"
                    th:selected="${year == nam}"
                  >
                    2025
                  </option>
                </select>
              </div>
              <div class="col-md-8">
                <div class="btn-group" role="group">
                  <a
                    th:href="@{/admin/tai-chinh/thong-ke}"
                    class="btn btn-outline-primary"
                  >
                    <i class="fas fa-chart-pie me-2"></i>Tổng quan
                  </a>
                  <a
                    th:href="@{/admin/tai-chinh/thong-ke/so-sanh}"
                    class="btn btn-outline-info"
                  >
                    <i class="fas fa-chart-line me-2"></i>So sánh
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-4 mb-4">
          <!-- Total Income -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-success text-white rounded-circle p-3">
                      <i class="fas fa-arrow-up fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-success mb-1">Tổng Thu</h6>
                    <h4
                      class="mb-0"
                      th:text="${#numbers.formatDecimal(thongKeNam?.tongThu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small class="text-muted" th:text="${soGiaoDichThu} + ' giao dịch'">0 giao dịch</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Expense -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-danger text-white rounded-circle p-3">
                      <i class="fas fa-arrow-down fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-danger mb-1">Tổng Chi</h6>
                    <h4
                      class="mb-0"
                      th:text="${#numbers.formatDecimal(thongKeNam?.tongChi ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small class="text-muted" th:text="${soGiaoDichChi} + ' giao dịch'">0 giao dịch</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Balance -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card"
              th:classappend="${(thongKeNam?.soDu ?: 0) >= 0} ? 'border-primary' : 'border-warning'"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'bg-primary text-white rounded-circle p-3' : 'bg-warning text-white rounded-circle p-3'"
                    >
                      <i class="fas fa-balance-scale fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6
                      class="mb-1"
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'text-primary' : 'text-warning'"
                    >
                      Số Dư
                    </h6>
                    <h4
                      class="mb-0"
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'text-success' : 'text-danger'"
                      th:text="${#numbers.formatDecimal(thongKeNam?.soDu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small
                      class="badge"
                      th:class="${(thongKeNam?.soDu ?: 0) > 0} ? 'bg-success' : (${(thongKeNam?.soDu ?: 0) < 0} ? 'bg-danger' : 'bg-warning')"
                      th:text="${(thongKeNam?.soDu ?: 0) > 0} ? 'Dương' : (${(thongKeNam?.soDu ?: 0) < 0} ? 'Âm' : 'Bằng 0')"
                      >Dương</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Transactions -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-info">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-info text-white rounded-circle p-3">
                      <i class="fas fa-list fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-info mb-1">Tổng Giao Dịch</h6>
                    <h4 class="mb-0" th:text="${totalGiaoDich}">0</h4>
                    </h4>
                    <small class="text-muted">giao dịch trong năm</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
          <!-- Monthly Trend Chart -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-line me-2"></i>Xu Hướng Theo Tháng
                </h5>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Category Distribution -->
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-pie me-2"></i>Phân Bố Theo Danh Mục
                </h5>
              </div>
              <div class="card-body">
                <canvas id="categoryChart" width="400" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Category Details Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-table me-2"></i>Chi Tiết Theo Danh Mục
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Danh Mục</th>
                    <th>Loại</th>
                    <th class="text-end">Số Tiền</th>
                    <th class="text-center">Số Giao Dịch</th>
                    <th class="text-end">Trung Bình</th>
                    <th class="text-center">% Tổng</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="category : ${thongKeTheoDanhMuc ?: {}}" th:if="${category != null}">
                    <td th:text="${category.length > 0 ? category[0] : 'N/A'}">Danh mục</td>
                    <td>
                      <span
                        class="badge"
                        th:class="${category.length > 1 and category[1] == 'THU'} ? 'bg-success' : 'bg-danger'"
                        th:text="${category.length > 1 and category[1] == 'THU'} ? 'Thu' : 'Chi'"
                        >Thu</span
                      >
                    </td>
                    <td
                      class="text-end"
                      th:class="${category.length > 1 and category[1] == 'THU'} ? 'text-success' : 'text-danger'"
                      th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}"
                    >
                      0 VNĐ
                    </td>
                    <td class="text-center" th:text="${category.length > 3 ? category[3] : 0}">0</td>
                    <td class="text-end" th:text="${category.length > 3 and category[3] > 0 ? (#numbers.formatDecimal(category[2] / category[3], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}">0 VNĐ</td>
                    <td class="text-center">
                      <span
                        th:if="${category.length > 1 and category[1] == 'THU' and (thongKeNam?.tongThu ?: 0) > 0}"
                        th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2] / (thongKeNam?.tongThu ?: 1) * 100, 1, 2) + '%') : '0%'}"
                        >0%</span
                      >
                      <span
                        th:if="${category.length > 1 and category[1] == 'CHI' and (thongKeNam?.tongChi ?: 0) > 0}"
                        th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2] / (thongKeNam?.tongChi ?: 1) * 100, 1, 2) + '%') : '0%'}"
                        >0%</span
                      >
                      <span
                        th:if="${category.length <= 1 or (category[1] == 'THU' and (thongKeNam?.tongThu ?: 0) == 0) or (category[1] == 'CHI' and (thongKeNam?.tongChi ?: 0) == 0)}"
                        >0%</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart.js Library -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <!-- Charts Script -->
      <script
        th:if="${thongKeTheoThang != null and thongKeTheoThang.size() > 0}"
      >
        // Debug: Check data structure
        console.log("thongKeTheoThang size:", /*[[${thongKeTheoThang.size()}]]*/ 0);
        console.log("thongKeTheoThang[8]:", /*[[${thongKeTheoThang[8]}]]*/ null);
        console.log("thongKeTheoThang[8][1]:", /*[[${thongKeTheoThang[8][1]}]]*/ 0);
        console.log("thongKeTheoThang[8][2]:", /*[[${thongKeTheoThang[8][2]}]]*/ 0);
        
        // Debug: Log monthly data
        console.log("Monthly data (Thu):", [
          /*[[${thongKeTheoThang[0][1]}]]*/ 0,
          /*[[${thongKeTheoThang[1][1]}]]*/ 0,
          /*[[${thongKeTheoThang[2][1]}]]*/ 0,
          /*[[${thongKeTheoThang[3][1]}]]*/ 0,
          /*[[${thongKeTheoThang[4][1]}]]*/ 0,
          /*[[${thongKeTheoThang[5][1]}]]*/ 0,
          /*[[${thongKeTheoThang[6][1]}]]*/ 0,
          /*[[${thongKeTheoThang[7][1]}]]*/ 0,
          /*[[${thongKeTheoThang[8][1]}]]*/ 0,
          /*[[${thongKeTheoThang[9][1]}]]*/ 0,
          /*[[${thongKeTheoThang[10][1]}]]*/ 0,
          /*[[${thongKeTheoThang[11][1]}]]*/ 0
        ]);
        console.log("Monthly data (Chi):", [
          /*[[${thongKeTheoThang[0][2]}]]*/ 0,
          /*[[${thongKeTheoThang[1][2]}]]*/ 0,
          /*[[${thongKeTheoThang[2][2]}]]*/ 0,
          /*[[${thongKeTheoThang[3][2]}]]*/ 0,
          /*[[${thongKeTheoThang[4][2]}]]*/ 0,
          /*[[${thongKeTheoThang[5][2]}]]*/ 0,
          /*[[${thongKeTheoThang[6][2]}]]*/ 0,
          /*[[${thongKeTheoThang[7][2]}]]*/ 0,
          /*[[${thongKeTheoThang[8][2]}]]*/ 0,
          /*[[${thongKeTheoThang[9][2]}]]*/ 0,
          /*[[${thongKeTheoThang[10][2]}]]*/ 0,
          /*[[${thongKeTheoThang[11][2]}]]*/ 0
        ]);
        
        // Monthly Trend Chart
        const monthlyCtx = document
          .getElementById("monthlyChart")
          .getContext("2d");
        const monthlyChart = new Chart(monthlyCtx, {
          type: "line",
          data: {
            labels: [
              "T1",
              "T2",
              "T3",
              "T4",
              "T5",
              "T6",
              "T7",
              "T8",
              "T9",
              "T10",
              "T11",
              "T12",
            ],
            datasets: [
              {
                label: "Thu",
                data: [
                  /*[[${thongKeTheoThang[0][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[1][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[2][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[3][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[4][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[5][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[6][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[7][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[8][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[9][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[10][1]}]]*/ 0,
                  /*[[${thongKeTheoThang[11][1]}]]*/ 0,
                ],
                borderColor: "rgba(40, 167, 69, 1)",
                backgroundColor: "rgba(40, 167, 69, 0.1)",
                tension: 0.4,
              },
              {
                label: "Chi",
                data: [
                  /*[[${thongKeTheoThang[0][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[1][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[2][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[3][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[4][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[5][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[6][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[7][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[8][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[9][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[10][2]}]]*/ 0,
                  /*[[${thongKeTheoThang[11][2]}]]*/ 0,
                ],
                borderColor: "rgba(220, 53, 69, 1)",
                backgroundColor: "rgba(220, 53, 69, 0.1)",
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text:
                  "Xu hướng thu chi theo tháng năm " + /*[[${nam}]]*/ "2025",
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return (
                      new Intl.NumberFormat("vi-VN").format(value) + " VNĐ"
                    );
                  },
                },
              },
            },
          },
        });

        // Debug: Log category data
        console.log("Category data:", [
          /*[# th:each="category : ${thongKeTheoDanhMuc ?: {}}"]*/
            /*[[${category != null and category.length > 2 ? category[2] : 0}]]*/0,
          /*[/]*/
        ]);
        
        // Category Distribution Chart
        const categoryCtx = document
          .getElementById("categoryChart")
          .getContext("2d");
        const categoryChart = new Chart(categoryCtx, {
          type: "doughnut",
          data: {
            labels: [
              /*[# th:each="category : ${thongKeTheoDanhMuc ?: {}}"]*/
                /*[[${category != null and category.length > 0 ? category[0] : 'Danh mục'}]]*/"Danh mục",
              /*[/]*/
            ],
            datasets: [
              {
                data: [
                  /*[# th:each="category : ${thongKeTheoDanhMuc ?: {}}"]*/
                    /*[[${category != null and category.length > 2 ? category[2] : 0}]]*/0,
                  /*[/]*/
                ],
                backgroundColor: [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                  "#FF9F40",
                  "#FF6384",
                  "#C9CBCF",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: "Phân bố theo danh mục",
              },
              legend: {
                position: "bottom",
              },
            },
          },
        });
      </script>

      <!-- Year Selector Script -->
      <script>
        function changeYear() {
          const year = document.getElementById("yearSelector").value;
          if (year) {
            window.location.href = "/admin/tai-chinh/thong-ke/nam/" + year;
          }
        }
      </script>
    </main>
  </body>
</html>
