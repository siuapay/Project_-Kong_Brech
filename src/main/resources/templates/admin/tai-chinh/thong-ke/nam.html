<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/admin-layout :: head}"></head>
  <body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

      <!-- Content -->
      <div class="container-fluid py-4">
        <!-- Flash Messages -->
        <div th:replace="~{fragments/admin-layout :: messages}"></div>

        <!-- Modern Page Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div
              class="card border-0 shadow-sm"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
              "
            >
              <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center text-white">
                    <div class="me-4">
                      <div
                        class="bg-opacity-20 rounded-circle p-3 d-flex align-items-center justify-content-center"
                        style="width: 70px; height: 70px"
                      >
                        <i class="fas fa-chart-bar fa-2x text-white"></i>
                      </div>
                    </div>
                    <div>
                      <h1 class="h2 mb-2 text-white fw-bold">
                        Thống Kê Tài Chính Năm
                        <span th:text="${nam}">2025</span>
                      </h1>
                      <p class="mb-0 text-white-50 fs-5">
                        Phân tích chi tiết thu chi và xu hướng tài chính
                      </p>
                    </div>
                  </div>
                  <div class="text-end">
                    <a
                      th:href="@{/admin/tai-chinh/thong-ke}"
                      class="btn-modern btn-modern-outline"
                    >
                      <i class="fas fa-arrow-left me-2"></i>Quay Lại
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Year Selector & Navigation -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 15px">
              <div class="card-body p-4">
                <div class="row align-items-center">
                  <div class="col-lg-4">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        <div
                          class="bg-primary bg-opacity-10 rounded-circle p-2 d-flex align-items-center justify-content-center"
                          style="width: 45px; height: 45px"
                        >
                          <i class="fas fa-calendar-alt text-primary"></i>
                        </div>
                      </div>
                      <div class="flex-grow-1">
                        <label class="form-label fw-semibold text-dark mb-1"
                          >Chọn Năm Thống Kê</label
                        >
                        <select
                          class="form-select form-select-lg border-0 bg-light"
                          id="yearSelector"
                          onchange="changeYear()"
                          style="border-radius: 10px"
                        >
                          <option
                            th:each="year : ${availableYears}"
                            th:value="${year}"
                            th:text="${year}"
                            th:selected="${year == nam}"
                          >
                            2025
                          </option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-8">
                    <div class="d-flex justify-content-end">
                      <div class="btn-group shadow-sm" role="group">
                        <a
                          th:href="@{/admin/tai-chinh/thong-ke}"
                          class="btn btn-outline-primary px-4 py-2"
                          style="border-radius: 10px 0 0 10px"
                        >
                          <i class="fas fa-chart-pie me-2"></i>Tổng quan
                        </a>
                        <a
                          th:href="@{/admin/tai-chinh/thong-ke/so-sanh}"
                          class="btn btn-outline-info px-4 py-2"
                          style="border-radius: 0 10px 10px 0"
                        >
                          <i class="fas fa-chart-line me-2"></i>So sánh
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Summary Cards -->
        <div class="row g-4 mb-4">
          <!-- Total Income -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card border-0 shadow-sm h-100"
              style="
                border-radius: 20px;
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
              "
            >
              <div class="card-body p-4 text-white">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="bg-opacity-20 rounded-circle p-3 d-flex align-items-center justify-content-center"
                    style="width: 60px; height: 60px"
                  >
                    <i class="fas fa-arrow-up fa-xl"></i>
                  </div>
                  <div class="text-end">
                    <div class="bg-opacity-20 rounded-pill px-3 py-1">
                      <small class="fw-semibold">Thu nhập</small>
                    </div>
                  </div>
                </div>
                <div>
                  <h6 class="text-white-50 mb-2 fw-normal">
                    Tổng Thu Năm <span th:text="${nam}">2025</span>
                  </h6>
                  <h3
                    class="mb-2 fw-bold"
                    th:text="${#numbers.formatDecimal(thongKeNam?.tongThu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                  >
                    0 VNĐ
                  </h3>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-receipt me-2"></i>
                    <small th:text="${soGiaoDichThu} + ' giao dịch'"
                      >0 giao dịch</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Expense -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card border-0 shadow-sm h-100"
              style="
                border-radius: 20px;
                background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
              "
            >
              <div class="card-body p-4 text-white">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="bg-opacity-20 rounded-circle p-3 d-flex align-items-center justify-content-center"
                    style="width: 60px; height: 60px"
                  >
                    <i class="fas fa-arrow-down fa-xl"></i>
                  </div>
                  <div class="text-end">
                    <div class="bg-opacity-20 rounded-pill px-3 py-1">
                      <small class="fw-semibold">Chi phí</small>
                    </div>
                  </div>
                </div>
                <div>
                  <h6 class="text-white-50 mb-2 fw-normal">
                    Tổng Chi Năm <span th:text="${nam}">2025</span>
                  </h6>
                  <h3
                    class="mb-2 fw-bold"
                    th:text="${#numbers.formatDecimal(thongKeNam?.tongChi ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                  >
                    0 VNĐ
                  </h3>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-receipt me-2"></i>
                    <small th:text="${soGiaoDichChi} + ' giao dịch'"
                      >0 giao dịch</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Balance -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card border-0 shadow-sm h-100"
              th:style="${(thongKeNam?.soDu ?: 0) >= 0} ? 'border-radius: 20px; background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);' : 'border-radius: 20px; background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);'"
            >
              <div class="card-body p-4 text-white">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="bg-opacity-20 rounded-circle p-3 d-flex align-items-center justify-content-center"
                    style="width: 60px; height: 60px"
                  >
                    <i class="fas fa-balance-scale fa-xl"></i>
                  </div>
                  <div class="text-end">
                    <div class="bg-opacity-20 rounded-pill px-3 py-1">
                      <small class="fw-semibold">Số dư</small>
                    </div>
                  </div>
                </div>
                <div>
                  <h6 class="text-white-50 mb-2 fw-normal">Số Dư Cuối Năm</h6>
                  <h3
                    class="mb-2 fw-bold"
                    th:text="${#numbers.formatDecimal(thongKeNam?.soDu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                  >
                    0 VNĐ
                  </h3>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line me-2"></i>
                    <small
                      class="badge bg-opacity-20 border-0"
                      th:text="${(thongKeNam?.soDu ?: 0) > 0} ? 'Dương' : (${(thongKeNam?.soDu ?: 0) < 0} ? 'Âm' : 'Bằng 0')"
                      >Dương</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Transactions -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card border-0 shadow-sm h-100"
              style="
                border-radius: 20px;
                background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
              "
            >
              <div class="card-body p-4 text-white">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <div
                    class="bg-opacity-20 rounded-circle p-3 d-flex align-items-center justify-content-center"
                    style="width: 60px; height: 60px"
                  >
                    <i class="fas fa-list fa-xl"></i>
                  </div>
                  <div class="text-end">
                    <div class="bg-opacity-20 rounded-pill px-3 py-1">
                      <small class="fw-semibold">Giao dịch</small>
                    </div>
                  </div>
                </div>
                <div>
                  <h6 class="text-white-50 mb-2 fw-normal">Tổng Giao Dịch</h6>
                  <h3 class="mb-2 fw-bold" th:text="${totalGiaoDich}">0</h3>
                  <div class="d-flex align-items-center">
                    <i class="fas fa-calendar-alt me-2"></i>
                    <small>giao dịch trong năm</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Charts Row -->
        <div class="row g-4 mb-4">
          <!-- Monthly Trend Chart -->
          <div class="col-lg-8">
            <div
              class="card border-0 shadow-sm h-100"
              style="border-radius: 20px"
            >
              <div class="card-header border-0 bg-transparent pt-4 px-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div
                      class="bg-primary bg-opacity-10 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center"
                      style="width: 45px; height: 45px"
                    >
                      <i class="fas fa-chart-line text-primary"></i>
                    </div>
                    <div>
                      <h5 class="mb-1 fw-bold text-dark">
                        Xu Hướng Theo Tháng
                      </h5>
                      <p class="mb-0 text-muted small">
                        Biểu đồ thu chi từng tháng trong năm
                        <span th:text="${nam}">2025</span>
                      </p>
                    </div>
                  </div>
                  <div class="dropdown">
                    <button
                      class="btn btn-light btn-sm rounded-pill"
                      type="button"
                      data-bs-toggle="dropdown"
                    >
                      <i class="fas fa-ellipsis-h"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li>
                        <a class="dropdown-item" href="#"
                          ><i class="fas fa-download me-2"></i>Xuất PDF</a
                        >
                      </li>
                      <li>
                        <a class="dropdown-item" href="#"
                          ><i class="fas fa-file-excel me-2"></i>Xuất Excel</a
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="card-body px-4 pb-4">
                <canvas id="monthlyChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Category Distribution -->
          <div class="col-lg-4">
            <div
              class="card border-0 shadow-sm h-100"
              style="border-radius: 20px"
            >
              <div class="card-header border-0 bg-transparent pt-4 px-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center">
                    <div
                      class="bg-success bg-opacity-10 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center"
                      style="width: 45px; height: 45px"
                    >
                      <i class="fas fa-chart-pie text-success"></i>
                    </div>
                    <div>
                      <h5 class="mb-1 fw-bold text-dark">Phân Bố Danh Mục</h5>
                      <p class="mb-0 text-muted small">
                        Tỷ lệ chi tiêu theo từng danh mục
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-body px-4 pb-4">
                <canvas id="categoryChart" width="400" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Modern Category Details Table -->
        <div class="card border-0 shadow-sm" style="border-radius: 20px">
          <div class="card-header border-0 bg-transparent pt-4 px-4">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div
                  class="bg-info bg-opacity-10 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center"
                  style="width: 45px; height: 45px"
                >
                  <i class="fas fa-table text-info"></i>
                </div>
                <div>
                  <h5 class="mb-1 fw-bold text-dark">Chi Tiết Theo Danh Mục</h5>
                  <p class="mb-0 text-muted small">
                    Phân tích chi tiết từng danh mục thu chi trong năm
                    <span th:text="${nam}">2025</span>
                  </p>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm rounded-pill px-3">
                  <i class="fas fa-filter me-1"></i>Lọc
                </button>
                <button class="btn btn-primary btn-sm rounded-pill px-3">
                  <i class="fas fa-download me-1"></i>Xuất
                </button>
              </div>
            </div>
          </div>
          <div class="card-body px-4 pb-4">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th
                      class="border-0 fw-semibold text-dark py-3"
                      style="border-radius: 10px 0 0 10px"
                    >
                      <i class="fas fa-tag me-2 text-primary"></i>Danh Mục
                    </th>
                    <th class="border-0 fw-semibold text-dark py-3 text-center">
                      <i class="fas fa-exchange-alt me-2 text-success"></i>Loại
                    </th>
                    <th class="border-0 fw-semibold text-dark py-3 text-end">
                      <i class="fas fa-money-bill-wave me-2 text-warning"></i>Số
                      Tiền
                    </th>
                    <th class="border-0 fw-semibold text-dark py-3 text-center">
                      <i class="fas fa-list-ol me-2 text-info"></i>Giao Dịch
                    </th>
                    <th class="border-0 fw-semibold text-dark py-3 text-end"
                        style="border-radius: 0 10px 10px 0">
                      <i class="fas fa-calculator me-2 text-secondary"></i>Trung
                      Bình
                    </th>

                  </tr>
                </thead>
                <tbody>
                  <tr
                    th:each="category : ${thongKeTheoDanhMuc ?: {}}"
                    th:if="${category != null}"
                    class="border-0"
                  >
                    <td class="py-3">
                      <div class="d-flex align-items-center">
                        <div
                          class="bg-primary bg-opacity-10 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center"
                          style="width: 35px; height: 35px"
                        >
                          <i class="fas fa-folder text-primary"></i>
                        </div>
                        <span
                          class="fw-semibold text-dark"
                          th:text="${category.length > 0 ? category[0] : 'N/A'}"
                          >Danh mục</span
                        >
                      </div>
                    </td>
                    <td class="text-center py-3">
                      <span
                        class="badge rounded-pill px-3 py-2 fw-semibold"
                        th:class="${category.length > 1 and category[1] == 'THU'} ? 'bg-success bg-opacity-15 text-success' : 'bg-opacity-15 text-danger'"
                        th:text="${category.length > 1 and category[1] == 'THU'} ? 'Thu nhập' : 'Chi phí'"
                        >Thu nhập</span
                      >
                    </td>
                    <td class="text-end py-3">
                      <span
                        class="fw-bold fs-6"
                        th:class="${category.length > 1 and category[1] == 'THU'} ? 'text-success' : 'text-danger'"
                        th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}"
                        >0 VNĐ</span
                      >
                    </td>
                    <td class="text-center py-3">
                      <span
                        class="badge bg-light text-dark rounded-pill px-3 py-2"
                        th:text="${category.length > 3 ? category[3] : 0}"
                        >0</span
                      >
                    </td>
                    <td class="text-end py-3">
                      <span
                        class="text-muted fw-medium"
                        th:text="${category.length > 3 and category[3] > 0 ? (#numbers.formatDecimal(category[2] / category[3], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}"
                        >0 VNĐ</span
                      >
                    </td>

                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart.js Library -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       <div th:replace="~{fragments/admin-layout :: scripts}"></div>

      <!-- Custom Styles -->
      <style>
        /* Modern Button Styles */
        .btn-modern {
          display: inline-flex;
          align-items: center;
          padding: 12px 24px;
          border-radius: 12px;
          font-weight: 600;
          text-decoration: none;
          transition: all 0.3s ease;
          border: 2px solid transparent;
          font-size: 14px;
          line-height: 1.5;
        }

        .btn-modern-outline {
          background: rgba(255, 255, 255, 0.1);
          color: white;
          border-color: rgba(255, 255, 255, 0.2);
          backdrop-filter: blur(10px);
        }

        .btn-modern-outline:hover {
          background: rgba(255, 255, 255, 0.2);
          color: white;
          border-color: rgba(255, 255, 255, 0.3);
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
          text-decoration: none;
        }

        /* Modern card hover effects */
        .card {
          transition: all 0.3s ease;
        }

        .card:hover {
          transform: translateY(-2px);
        }

        /* Custom scrollbar for table */
        .table-responsive::-webkit-scrollbar {
          height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 10px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
          background: #c1c1c1;
          border-radius: 10px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
          background: #a8a8a8;
        }

        /* Table row hover effect */
        .table tbody tr {
          transition: all 0.2s ease;
        }

        .table tbody tr:hover {
          background-color: rgba(0, 123, 255, 0.05) !important;
          transform: scale(1.01);
        }

        /* Progress bar animation */
        .progress-bar {
          transition: width 0.6s ease;
        }

        /* Badge hover effects */
        .badge {
          transition: all 0.2s ease;
        }

        .badge:hover {
          transform: scale(1.05);
        }

        /* Button hover effects */
        .btn {
          transition: all 0.3s ease;
        }

        .btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Form select modern styling */
        .form-select:focus {
          border-color: #80bdff;
          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Chart container styling */
        #monthlyChart,
        #categoryChart {
          border-radius: 10px;
        }

        /* Breadcrumb styling */
        .breadcrumb-item + .breadcrumb-item::before {
          content: "›";
          font-weight: bold;
        }

        /* Dropdown menu styling */
        .dropdown-menu {
          border: none;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          border-radius: 10px;
        }

        .dropdown-item {
          transition: all 0.2s ease;
        }

        .dropdown-item:hover {
          background-color: rgba(0, 123, 255, 0.1);
          transform: translateX(5px);
        }

        /* Loading animation for charts */
        .chart-loading {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          font-size: 18px;
          color: #6c757d;
        }

        .chart-loading::after {
          content: "";
          width: 20px;
          height: 20px;
          border: 2px solid #f3f3f3;
          border-top: 2px solid #007bff;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-left: 10px;
        }

        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
          .card-body {
            padding: 1rem !important;
          }

          .btn-group {
            flex-direction: column;
            width: 100%;
          }

          .btn-group .btn {
            border-radius: 10px !important;
            margin-bottom: 5px;
          }

          .table-responsive {
            font-size: 0.875rem;
          }
        }
      </style>

      <!-- Charts Script -->
      <script>
        // Get year from URL or default to current year
        const currentYear = /*[[${nam}]]*/ new Date().getFullYear();

        // Load chart data from API
        function loadChartData() {
          fetch(`/admin/tai-chinh/api/thong-ke/nam/${currentYear}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                createMonthlyChart(data.xuHuongTheoThang);
                createCategoryChart(data.phanBoTheoDanhMuc);

                // Update summary cards if needed
                updateSummaryCards(data);
              } else {
                // Fallback to empty charts
                createMonthlyChart([]);
                createCategoryChart([]);
              }
            })
            .catch((error) => {
              // Fallback to empty charts
              createMonthlyChart([]);
              createCategoryChart([]);
            });
        }

        // Create Monthly Trend Chart
        function createMonthlyChart(xuHuongData) {
          const monthlyCtx = document
            .getElementById("monthlyChart")
            .getContext("2d");

          const labels = xuHuongData.map(
            (item) => item.tenThang || `Tháng ${item.thang}`
          );
          const thuData = xuHuongData.map((item) => item.tongThu || 0);
          const chiData = xuHuongData.map((item) => item.tongChi || 0);

          const monthlyChart = new Chart(monthlyCtx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Thu nhập",
                  data: thuData,
                  borderColor: "#28a745",
                  backgroundColor: "rgba(40, 167, 69, 0.1)",
                  borderWidth: 3,
                  pointBackgroundColor: "#28a745",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                  tension: 0.4,
                  fill: true,
                },
                {
                  label: "Chi phí",
                  data: chiData,
                  borderColor: "#dc3545",
                  backgroundColor: "rgba(220, 53, 69, 0.1)",
                  borderWidth: 3,
                  pointBackgroundColor: "#dc3545",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: "top",
                  labels: {
                    usePointStyle: true,
                    padding: 20,
                    font: {
                      size: 14,
                      weight: "bold",
                    },
                  },
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  titleColor: "#ffffff",
                  bodyColor: "#ffffff",
                  borderColor: "#ffffff",
                  borderWidth: 1,
                  cornerRadius: 10,
                  displayColors: true,
                  callbacks: {
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": " +
                        new Intl.NumberFormat("vi-VN").format(
                          context.parsed.y
                        ) +
                        " VNĐ"
                      );
                    },
                  },
                },
              },
              scales: {
                x: {
                  grid: {
                    display: false,
                  },
                  ticks: {
                    font: {
                      size: 12,
                      weight: "bold",
                    },
                    color: "#6c757d",
                  },
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    color: "rgba(0, 0, 0, 0.1)",
                    drawBorder: false,
                  },
                  ticks: {
                    font: {
                      size: 12,
                    },
                    color: "#6c757d",
                    callback: function (value) {
                      return (
                        new Intl.NumberFormat("vi-VN", {
                          notation: "compact",
                          compactDisplay: "short",
                        }).format(value) + " VNĐ"
                      );
                    },
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
            },
          });
        }

        // Create Category Distribution Chart
        function createCategoryChart(categoryData) {
          const categoryCtx = document
            .getElementById("categoryChart")
            .getContext("2d");

          const labels = categoryData.map(
            (item) => item.tenDanhMuc || "Danh mục"
          );
          const data = categoryData.map((item) => item.soTien || 0);

          // Modern color palette
          const colors = [
            "#FF6B6B",
            "#4ECDC4",
            "#45B7D1",
            "#96CEB4",
            "#FFEAA7",
            "#DDA0DD",
            "#98D8C8",
            "#F7DC6F",
            "#BB8FCE",
            "#85C1E9",
            "#F8C471",
            "#82E0AA",
            "#F1948A",
            "#85C1E9",
            "#D7BDE2",
          ];

          const backgroundColors = labels.map(
            (_, index) => colors[index % colors.length]
          );

          const categoryChart = new Chart(categoryCtx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: backgroundColors,
                  borderWidth: 0,
                  hoverBorderWidth: 3,
                  hoverBorderColor: "#ffffff",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: "60%",
              plugins: {
                legend: {
                  display: true,
                  position: "bottom",
                  labels: {
                    usePointStyle: true,
                    padding: 15,
                    font: {
                      size: 12,
                      weight: "bold",
                    },
                    generateLabels: function (chart) {
                      const data = chart.data;
                      if (data.labels.length && data.datasets.length) {
                        const total = data.datasets[0].data.reduce(
                          (a, b) => a + b,
                          0
                        );
                        return data.labels.map((label, i) => {
                          const value = data.datasets[0].data[i];
                          const percentage = ((value / total) * 100).toFixed(1);
                          return {
                            text: `${label} (${percentage}%)`,
                            fillStyle: data.datasets[0].backgroundColor[i],
                            strokeStyle: data.datasets[0].backgroundColor[i],
                            pointStyle: "circle",
                          };
                        });
                      }
                      return [];
                    },
                  },
                },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  titleColor: "#ffffff",
                  bodyColor: "#ffffff",
                  borderColor: "#ffffff",
                  borderWidth: 1,
                  cornerRadius: 10,
                  callbacks: {
                    label: function (context) {
                      const value = context.parsed;
                      const total = context.dataset.data.reduce(
                        (a, b) => a + b,
                        0
                      );
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${context.label}: ${new Intl.NumberFormat(
                        "vi-VN"
                      ).format(value)} VNĐ (${percentage}%)`;
                    },
                  },
                },
              },
              animation: {
                animateRotate: true,
                animateScale: true,
              },
            },
          });
        }

        // Update summary cards with API data
        function updateSummaryCards(data) {
          // This is optional - you can update the summary cards with fresh data from API
        }

        // Load data when page loads
        document.addEventListener("DOMContentLoaded", function () {
          loadChartData();
        });
      </script>

      <!-- Year Selector Script -->
      <script>
        function changeYear() {
          const year = document.getElementById("yearSelector").value;
          if (year) {
            window.location.href = "/admin/tai-chinh/thong-ke/nam/" + year;
          }
        }
      </script>
    </main>
  </body>
</html>
