<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/admin-layout :: head}"></head>
  <body>
    <!-- Sidebar -->
    <nav th:replace="~{fragments/admin-layout :: sidebar}"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Navigation -->
      <nav th:replace="~{fragments/admin-layout :: topnav}"></nav>

      <!-- Content -->
      <div class="container-fluid py-4">
        <!-- Flash Messages -->
        <div th:replace="~{fragments/admin-layout :: messages}"></div>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="h3 mb-0" th:text="${pageTitle}">
              Thống Kê Tài Chính Năm
            </h1>
            <p class="text-muted">
              Chi tiết thu chi theo năm <span th:text="${nam}">2025</span>
            </p>
          </div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/admin}">Trang chủ</a>
              </li>
              <li class="breadcrumb-item">
                <a th:href="@{/admin/tai-chinh/thong-ke}">Thống kê</a>
              </li>
              <li class="breadcrumb-item active" th:text="'Năm ' + ${nam}">
                Năm 2025
              </li>
            </ol>
          </nav>
        </div>

        <!-- Year Selector -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-calendar-alt me-2"></i>Chọn Năm
            </h5>
          </div>
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-4">
                <select
                  class="form-select"
                  id="yearSelector"
                  onchange="changeYear()"
                >
                  <option
                    th:each="year : ${availableYears}"
                    th:value="${year}"
                    th:text="${year}"
                    th:selected="${year == nam}"
                  >
                    2025
                  </option>
                </select>
              </div>
              <div class="col-md-8">
                <div class="btn-group" role="group">
                  <a
                    th:href="@{/admin/tai-chinh/thong-ke}"
                    class="btn btn-outline-primary"
                  >
                    <i class="fas fa-chart-pie me-2"></i>Tổng quan
                  </a>
                  <a
                    th:href="@{/admin/tai-chinh/thong-ke/so-sanh}"
                    class="btn btn-outline-info"
                  >
                    <i class="fas fa-chart-line me-2"></i>So sánh
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row g-4 mb-4">
          <!-- Total Income -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-success">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-success text-white rounded-circle p-3">
                      <i class="fas fa-arrow-up fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-success mb-1">Tổng Thu</h6>
                    <h4
                      class="mb-0"
                      th:text="${#numbers.formatDecimal(thongKeNam?.tongThu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small class="text-muted" th:text="${soGiaoDichThu} + ' giao dịch'">0 giao dịch</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Expense -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-danger">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-danger text-white rounded-circle p-3">
                      <i class="fas fa-arrow-down fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-danger mb-1">Tổng Chi</h6>
                    <h4
                      class="mb-0"
                      th:text="${#numbers.formatDecimal(thongKeNam?.tongChi ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small class="text-muted" th:text="${soGiaoDichChi} + ' giao dịch'">0 giao dịch</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Balance -->
          <div class="col-xl-3 col-md-6">
            <div
              class="card"
              th:classappend="${(thongKeNam?.soDu ?: 0) >= 0} ? 'border-primary' : 'border-warning'"
            >
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'bg-primary text-white rounded-circle p-3' : 'bg-warning text-white rounded-circle p-3'"
                    >
                      <i class="fas fa-balance-scale fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6
                      class="mb-1"
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'text-primary' : 'text-warning'"
                    >
                      Số Dư
                    </h6>
                    <h4
                      class="mb-0"
                      th:class="${(thongKeNam?.soDu ?: 0) >= 0} ? 'text-success' : 'text-danger'"
                      th:text="${#numbers.formatDecimal(thongKeNam?.soDu ?: 0, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"
                    >
                      0 VNĐ
                    </h4>
                    <small
                      class="badge"
                      th:class="${(thongKeNam?.soDu ?: 0) > 0} ? 'bg-success' : (${(thongKeNam?.soDu ?: 0) < 0} ? 'bg-danger' : 'bg-warning')"
                      th:text="${(thongKeNam?.soDu ?: 0) > 0} ? 'Dương' : (${(thongKeNam?.soDu ?: 0) < 0} ? 'Âm' : 'Bằng 0')"
                      >Dương</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Total Transactions -->
          <div class="col-xl-3 col-md-6">
            <div class="card border-info">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0">
                    <div class="bg-info text-white rounded-circle p-3">
                      <i class="fas fa-list fa-lg"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h6 class="text-info mb-1">Tổng Giao Dịch</h6>
                    <h4 class="mb-0" th:text="${totalGiaoDich}">0</h4>
                    </h4>
                    <small class="text-muted">giao dịch trong năm</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
          <!-- Monthly Trend Chart -->
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-line me-2"></i>Xu Hướng Theo Tháng
                </h5>
              </div>
              <div class="card-body">
                <canvas id="monthlyChart" width="400" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Category Distribution -->
          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-chart-pie me-2"></i>Phân Bố Theo Danh Mục
                </h5>
              </div>
              <div class="card-body">
                <canvas id="categoryChart" width="400" height="400"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Category Details Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              <i class="fas fa-table me-2"></i>Chi Tiết Theo Danh Mục
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Danh Mục</th>
                    <th>Loại</th>
                    <th class="text-end">Số Tiền</th>
                    <th class="text-center">Số Giao Dịch</th>
                    <th class="text-end">Trung Bình</th>
                    <th class="text-center">% Tổng</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="category : ${thongKeTheoDanhMuc ?: {}}" th:if="${category != null}">
                    <td th:text="${category.length > 0 ? category[0] : 'N/A'}">Danh mục</td>
                    <td>
                      <span
                        class="badge"
                        th:class="${category.length > 1 and category[1] == 'THU'} ? 'bg-success' : 'bg-danger'"
                        th:text="${category.length > 1 and category[1] == 'THU'} ? 'Thu' : 'Chi'"
                        >Thu</span
                      >
                    </td>
                    <td
                      class="text-end"
                      th:class="${category.length > 1 and category[1] == 'THU'} ? 'text-success' : 'text-danger'"
                      th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}"
                    >
                      0 VNĐ
                    </td>
                    <td class="text-center" th:text="${category.length > 3 ? category[3] : 0}">0</td>
                    <td class="text-end" th:text="${category.length > 3 and category[3] > 0 ? (#numbers.formatDecimal(category[2] / category[3], 0, 'COMMA', 0, 'POINT') + ' VNĐ') : '0 VNĐ'}">0 VNĐ</td>
                    <td class="text-center">
                      <span
                        th:if="${category.length > 1 and category[1] == 'THU' and (thongKeNam?.tongThu ?: 0) > 0}"
                        th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2] / (thongKeNam?.tongThu ?: 1) * 100, 1, 2) + '%') : '0%'}"
                        >0%</span
                      >
                      <span
                        th:if="${category.length > 1 and category[1] == 'CHI' and (thongKeNam?.tongChi ?: 0) > 0}"
                        th:text="${category.length > 2 ? (#numbers.formatDecimal(category[2] / (thongKeNam?.tongChi ?: 1) * 100, 1, 2) + '%') : '0%'}"
                        >0%</span
                      >
                      <span
                        th:if="${category.length <= 1 or (category[1] == 'THU' and (thongKeNam?.tongThu ?: 0) == 0) or (category[1] == 'CHI' and (thongKeNam?.tongChi ?: 0) == 0)}"
                        >0%</span
                      >
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart.js Library -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <!-- Charts Script -->
      <script>
        // Get year from URL or default to current year
        const currentYear = /*[[${nam}]]*/ new Date().getFullYear();
        
        // Load chart data from API
        function loadChartData() {
          fetch(`/admin/tai-chinh/api/thong-ke/nam/${currentYear}`)
            .then(response => response.json())
            .then(data => {
              console.log('API Response:', data);
              
              if (data.success) {
                createMonthlyChart(data.xuHuongTheoThang);
                createCategoryChart(data.phanBoTheoDanhMuc);
                
                // Update summary cards if needed
                updateSummaryCards(data);
              } else {
                console.error('API Error:', data.error);
                // Fallback to empty charts
                createMonthlyChart([]);
                createCategoryChart([]);
              }
            })
            .catch(error => {
              console.error('Error loading chart data:', error);
              // Fallback to empty charts
              createMonthlyChart([]);
              createCategoryChart([]);
            });
        }
        
        // Create Monthly Trend Chart
        function createMonthlyChart(xuHuongData) {
          const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
          
          const labels = xuHuongData.map(item => item.tenThang || `T${item.thang}`);
          const thuData = xuHuongData.map(item => item.tongThu || 0);
          const chiData = xuHuongData.map(item => item.tongChi || 0);
          
          console.log('Monthly chart data:', { labels, thuData, chiData });
          
          const monthlyChart = new Chart(monthlyCtx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Thu",
                  data: thuData,
                  borderColor: "rgba(40, 167, 69, 1)",
                  backgroundColor: "rgba(40, 167, 69, 0.1)",
                  tension: 0.4,
                },
                {
                  label: "Chi",
                  data: chiData,
                  borderColor: "rgba(220, 53, 69, 1)",
                  backgroundColor: "rgba(220, 53, 69, 0.1)",
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: `Xu hướng thu chi theo tháng năm ${currentYear}`,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return new Intl.NumberFormat("vi-VN").format(value) + " VNĐ";
                    },
                  },
                },
              },
            },
          });
        }
        
        // Create Category Distribution Chart
        function createCategoryChart(categoryData) {
          const categoryCtx = document.getElementById("categoryChart").getContext("2d");
          
          const labels = categoryData.map(item => item.tenDanhMuc || 'Danh mục');
          const data = categoryData.map(item => item.soTien || 0);
          const colors = categoryData.map(item => item.mauSac || '#FF6384');
          
          console.log('Category chart data:', { labels, data, colors });
          
          const categoryChart = new Chart(categoryCtx, {
            type: "doughnut",
            data: {
              labels: labels,
              datasets: [
                {
                  data: data,
                  backgroundColor: colors,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Phân bố theo danh mục",
                },
                legend: {
                  position: "bottom",
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const value = context.parsed;
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = ((value / total) * 100).toFixed(1);
                      return `${context.label}: ${new Intl.NumberFormat("vi-VN").format(value)} VNĐ (${percentage}%)`;
                    }
                  }
                }
              },
            },
          });
        }
        
        // Update summary cards with API data
        function updateSummaryCards(data) {
          // This is optional - you can update the summary cards with fresh data from API
          console.log('Summary data:', {
            tongThu: data.tongThu,
            tongChi: data.tongChi,
            soDu: data.soDu
          });
        }
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
          loadChartData();
        });
      </script>

      <!-- Year Selector Script -->
      <script>
        function changeYear() {
          const year = document.getElementById("yearSelector").value;
          if (year) {
            window.location.href = "/admin/tai-chinh/thong-ke/nam/" + year;
          }
        }
      </script>
    </main>
  </body>
</html>
